<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×‘×•××• × ×›×™×¨ - ×”×¡×•×›×Ÿ ×©×œ×š ×œ× ×“×œ"×Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600;700&display=swap');
        body { 
            font-family: 'Heebo', sans-serif;
            overflow-x: hidden;
        }
        
        .chat-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
        }
        
        .message {
            margin-bottom: 1rem;
            opacity: 0;
            animation: fadeIn 0.4s ease-out forwards;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .agent-message {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
        }
        
        .agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        
        .agent-bubble {
            background: white;
            padding: 0.875rem 1.125rem;
            border-radius: 1.25rem;
            border-top-right-radius: 0.25rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            max-width: 80%;
        }
        
        .user-message {
            display: flex;
            justify-content: flex-start;
            margin-right: 3rem;
        }
        
        .user-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.875rem 1.125rem;
            border-radius: 1.25rem;
            border-top-left-radius: 0.25rem;
            max-width: 70%;
        }
        
        .typing-indicator {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .typing-dots {
            background: white;
            padding: 0.875rem 1.125rem;
            border-radius: 1.25rem;
            border-top-right-radius: 0.25rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            display: flex;
            gap: 0.375rem;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #cbd5e1;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        
        .input-area {
            padding: 1rem 1.5rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }
        
        .choice-btn {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            background: white;
            border: 1.5px solid #e5e7eb;
            border-radius: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            font-weight: 400;
        }
        
        .choice-btn:hover {
            border-color: #667eea;
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
        }
        
        .choice-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .text-input-box {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .text-input-box input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 1.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .text-input-box input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .text-input-box button {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 1.5rem;
            cursor: pointer;
            font-weight: 500;
            transition: opacity 0.2s;
        }
        
        .text-input-box button:hover {
            opacity: 0.9;
        }
        
        .text-input-box button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .hidden { display: none !important; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50">
    <div class="chat-container max-w-3xl mx-auto bg-white/50 backdrop-blur-sm">
        <div id="messages" class="messages"></div>
        <div id="inputArea" class="input-area hidden"></div>
    </div>

    <script>
        const formData = {
            cities: [],
            rooms: [],
            mustHaves: []
        };
        
        let currentStep = 0;
        let typingTimeout;
        
        const conversation = [
            {
                agent: "×”×™×™! ×× ×™ ×”×¡×•×›×Ÿ ×”××™×©×™ ×©×œ×š ×œ××¦×™××ª ×“×™×¨×” ğŸ‘‹",
                delay: 800
            },
            {
                agent: "×‘×•× × ×•×“×” ×‘×××ª, ×—×™×¤×•×© ×“×™×¨×” ×™×›×•×œ ×œ×”×ª×™×© â€” ×’×•×œ×œ×™× ×‘×™×“2, ××“×œ×Ÿ, ×§×‘×•×¦×•×ª ×¤×™×™×¡×‘×•×§ ×•×•×•××˜×¡××¤, ×•××—×¨×™ ×›×œ ×–×” ×¢×“×™×™×Ÿ ××¨×’×™×©×™× ×©××¤×¡×¤×¡×™× ××ª ×”×“×™×¨×•×ª ×”×˜×•×‘×•×ª.",
                delay: 1500
            },
            {
                agent: "×‘×“×™×•×§ ×‘×©×‘×™×œ ×–×” ×× ×™ ×›××Ÿ: ×× ×™ ×¢×•×‘×“ ×‘×©×‘×™×œ×š, ×¡×•×¨×§ ××ª ×”×©×•×§ ×›×œ ×”×–××Ÿ ×•××‘×™× ×¨×§ ×“×™×¨×•×ª ×©×‘×××ª ××ª××™××•×ª ×œ×š.",
                delay: 1500
            },
            {
                agent: "××—×¤×©×™× ×“×™×¨×” ×œ×§× ×™×™×” ××• ×œ×©×›×™×¨×•×ª?",
                type: "choice",
                field: "searchType",
                choices: [
                    { label: "ğŸ  ×§× ×™×™×”", value: "buy" },
                    { label: "ğŸ”‘ ×©×›×™×¨×•×ª", value: "rent" }
                ],
                delay: 1000
            },
            {
                agent: (data) => data.searchType === 'rent' ? "××¢×•×œ×”! ×‘×•× × ××¦× ×œ×š ×“×™×¨×” ×œ×©×›×™×¨×•×ª" : "××¢×•×œ×”! ×‘×•× × ××¦× ×œ×š ×“×™×¨×” ×œ×§× ×™×™×”",
                delay: 800
            },
            {
                agent: "××’×‘, ××™×š ×œ×¤× ×•×ª ××œ×™×š?",
                type: "text",
                field: "name",
                placeholder: "×”×©× ×©×œ×š",
                delay: 800
            },
            {
                agent: (data) => `× ×¢×™× ×××•×“, ${data.name} ğŸ˜Š`,
                delay: 800
            },
            {
                agent: "×‘××™×œ×• ××–×•×¨×™× ×œ×—×¤×©? ××¤×©×¨ ×œ×‘×—×•×¨ ×›××”, ××• ×œ×”×•×¡×™×£ ××–×•×¨ ×‘×¢×¦××š.",
                type: "multichoice",
                field: "cities",
                choices: [
                    { label: "×ª×œ ××‘×™×‘", value: "×ª×œ ××‘×™×‘" },
                    { label: "×¨××ª ×’×Ÿ", value: "×¨××ª ×’×Ÿ" },
                    { label: "×’×‘×¢×ª×™×™×", value: "×’×‘×¢×ª×™×™×" },
                    { label: "×—×•×œ×•×Ÿ", value: "×—×•×œ×•×Ÿ" },
                    { label: "×‘×ª ×™×", value: "×‘×ª ×™×" },
                    { label: "×™×¨×•×©×œ×™×", value: "×™×¨×•×©×œ×™×" },
                    { label: "×—×™×¤×”", value: "×—×™×¤×”" }
                ],
                allowCustom: true,
                customPlaceholder: "××• ×›×ª×•×‘ ×¢×™×¨ ××—×¨×ª...",
                delay: 1000
            },
            {
                agent: (data) => `×¡×‘×‘×”, ×× ×™ ××—×¤×© ×‘${data.cities.join(", ")}`,
                delay: 800
            },
            {
                agent: "××” ×˜×•×•×— ×”×ª×§×¦×™×‘ ×”×—×•×“×©×™?",
                type: "budget",
                delay: 1000
            },
            {
                agent: (data) => {
                    const min = data.minPrice ? parseInt(data.minPrice).toLocaleString() : null;
                    const max = data.maxPrice ? parseInt(data.maxPrice).toLocaleString() : null;
                    
                    if (min && max) {
                        return `××—×œ×”, ×× ×™ ××—×¤×© ×‘×˜×•×•×— ×©×œ ${min}-${max} ×©×´×—`;
                    } else if (min && !max) {
                        return `×¡×’×•×¨, ×× ×™ ××©×œ×— ×œ×š ×¨×§ × ×›×¡×™× ××¢×œ ${min} ×©×´×—`;
                    } else if (!min && max) {
                        return `××¢×•×œ×”, ×× ×™ ××—×¤×© ×œ×š × ×›×¡×™× ×¢×“ ${max} ×©×´×—`;
                    } else {
                        return null; // Skip this step entirely if no budget entered
                    }
                },
                skipIfNull: true,
                delay: 800
            },
            {
                agent: "×›××” ×—×“×¨×™× ×œ×—×¤×©?",
                type: "multichoice",
                field: "rooms",
                choices: [
                    { label: "1 ×—×“×¨", value: "1" },
                    { label: "2 ×—×“×¨×™×", value: "2" },
                    { label: "3 ×—×“×¨×™×", value: "3" },
                    { label: "4 ×—×“×¨×™×", value: "4" },
                    { label: "5+ ×—×“×¨×™×", value: "5+" }
                ],
                delay: 1000
            },
            {
                agent: "×™×© ×“×‘×¨×™× ×©×”× ×—×•×‘×” ×‘×“×™×¨×”? ×¨×§ ××ª ××” ×©×‘×œ×¢×“×™×• ×”×“×™×¨×” ×œ× ×¨×œ×•×•× ×˜×™×ª.",
                type: "multichoice",
                field: "mustHaves",
                choices: [
                    { label: "××¢×œ×™×ª", value: "××¢×œ×™×ª" },
                    { label: "×—× ×™×”", value: "×—× ×™×”" },
                    { label: "×××´×“", value: "×××´×“" },
                    { label: "××¨×¤×¡×ª", value: "××¨×¤×¡×ª" },
                    { label: "×§×•××” × ××•×›×”", value: "×§×•××” × ××•×›×”" },
                    { label: "××©×•×¤×¥", value: "××©×•×¤×¥" },
                    { label: "××™×–×•×’", value: "××™×–×•×’" }
                ],
                optional: true,
                delay: 1000
            },
            {
                agent: "×™×© ×¢×•×“ ××©×”×• ×©×—×©×•×‘ ×©××“×¢?",
                type: "text",
                field: "additionalNotes",
                placeholder: "×œ×“×•×’××”: ×§×¨×•×‘ ×œ×’×Ÿ ×™×œ×“×™×, ×©×§×˜, ×¢× × ×•×£...",
                optional: true,
                delay: 1000
            },
            {
                agent: (data) => {
                    const searchType = data.searchType === 'rent' ? '×©×›×™×¨×•×ª' : '×§× ×™×™×”';
                    const areas = data.cities.join(", ");
                    
                    let budget = '';
                    if (data.minPrice && data.maxPrice) {
                        budget = `×‘×˜×•×•×— ×ª×§×¦×™×‘ ×©×œ ${parseInt(data.minPrice).toLocaleString()}-${parseInt(data.maxPrice).toLocaleString()} ×©×´×—`;
                    } else if (data.minPrice) {
                        budget = `××¢×œ ${parseInt(data.minPrice).toLocaleString()} ×©×´×—`;
                    } else if (data.maxPrice) {
                        budget = `×¢×“ ${parseInt(data.maxPrice).toLocaleString()} ×©×´×—`;
                    } else {
                        budget = '×‘×›×œ ×˜×•×•×— ×ª×§×¦×™×‘';
                    }
                    
                    const rooms = data.rooms.length > 0 ? data.rooms.join(", ") : "×›×œ ×’×•×“×œ";
                    
                    let mustHaves = '';
                    if (data.mustHaves && data.mustHaves.length > 0) {
                        mustHaves = `, ×•×“×’×© ×¢×œ: ${data.mustHaves.join(", ")}`;
                    }
                    
                    return `××¢×•×œ×”. ××– ×–×” ××” ×©×× ×™ ×”×•×œ×š ×œ×—×¤×© ×‘×©×‘×™×œ×š ğŸ‘ˆ

×“×™×¨×ª ${searchType} ×‘${areas}, ${budget}, ×¢× ${rooms} ×—×“×¨×™×${mustHaves}.`;
                },
                delay: 1200
            },
            {
                agent: "×× ×™ ×¢×œ ×–×” â€” ×¡×•×¨×§ ××ª ×”×©×•×§ ×•××¡× ×Ÿ ×‘×©×‘×™×œ×š ×›×œ ×™×•×. ×™×© ×œ×™ ××•×¨ ×™×¨×•×§ ×××š ×œ×¦××ª ×œ×“×¨×š?",
                type: "choice",
                field: "confirmation",
                choices: [
                    { label: "âœ” ×›×Ÿ, ××•×¨ ×™×¨×•×§", value: "confirmed" },
                    { label: "âœï¸ ×¨×•×¦×” ×œ×©× ×•×ª ××©×”×•", value: "edit" }
                ],
                handleEdit: true,
                delay: 1200
            },
            {
                agent: "××¢×•×œ×”! ×¨×§ ×¢×•×“ ×›××” ×¤×¨×˜×™× ×˜×›× ×™×™× ×›×“×™ ×©××•×›×œ ×œ×©×œ×•×— ×œ×š ×¢×“×›×•× ×™×",
                delay: 800
            },
            {
                agent: "×œ××Ÿ ×œ×©×œ×•×— ×¢×“×›×•× ×™×?",
                type: "text",
                field: "email",
                inputType: "email",
                placeholder: "example@email.com",
                delay: 800
            },
            {
                agent: "×•××¡×¤×¨ ×˜×œ×¤×•×Ÿ? (××•×¤×¦×™×•× ×œ×™)",
                type: "text",
                field: "phone",
                inputType: "tel",
                placeholder: "05X-XXXXXXX",
                optional: true,
                delay: 800
            },
            {
                agent: "ğŸ‰ ×¡×’×•×¨! ×× ×™ ××ª×—×™×œ ×œ×¢×‘×•×“ ×‘×©×‘×™×œ×š ×¢×›×©×™×•",
                delay: 1000
            },
            {
                agent: "×©××œ×” ××—×¨×•× ×”: ×”×—×™×¤×•×© ×”×•× ×™×—×“ ×¢× ×¢×•×“ ×× ×©×™×? ×× ×›×Ÿ, ×× ×™ ×™×›×•×œ ×œ×¢×“×›×Ÿ ××ª ×›×•×œ×›× ×‘××§×‘×™×œ ×›×“×™ ×©×›×•×œ× ×™×”×™×• ××™×•×©×¨×™× ×•×™×•×›×œ×• ×œ×”×’×™×‘ ×‘×–××Ÿ.",
                type: "text",
                field: "coSearchers",
                placeholder: "×œ××©×œ: sara@email.com, david@email.com (××• ×“×œ×’)",
                optional: true,
                delay: 1000
            },
            {
                agent: (data) => {
                    if (data.coSearchers) {
                        return "××¢×•×œ×”! ×× ×™ ××•×¡×™×£ ××ª ×›×•×œ× ×œ×¢×“×›×•× ×™× ğŸ‘";
                    }
                    return null;
                },
                skipIfNull: true,
                delay: 800
            },
            {
                agent: "×× ×™ ××¡×¨×•×§ ××ª ×”×©×•×§ ×‘××•×¤×Ÿ ×§×‘×•×¢ ×•××©×œ×— ×œ×š ×¨×§ ×“×™×¨×•×ª ×©×‘×××ª ×©×•×•×ª ××ª ×”×–××Ÿ ×©×œ×š.",
                type: "complete",
                delay: 1000
            }
        ];
        
        function addMessage(type, content, isTyping = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            
            if (type === 'agent') {
                if (isTyping) {
                    messageDiv.className = 'typing-indicator';
                    messageDiv.innerHTML = `
                        <div class="agent-avatar">ğŸ </div>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    `;
                } else {
                    messageDiv.className = 'message agent-message';
                    messageDiv.innerHTML = `
                        <div class="agent-avatar">ğŸ </div>
                        <div class="agent-bubble">${content}</div>
                    `;
                }
            } else if (type === 'user') {
                messageDiv.className = 'message user-message';
                messageDiv.innerHTML = `
                    <div class="user-bubble">${content}</div>
                `;
            }
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            return messageDiv;
        }
        
        function showTyping() {
            return addMessage('agent', '', true);
        }
        
        function removeTyping(typingElement) {
            if (typingElement && typingElement.parentNode) {
                typingElement.parentNode.removeChild(typingElement);
            }
        }
        
        function showInput(step) {
            const messagesDiv = document.getElementById('messages');
            const inputArea = document.getElementById('inputArea');
            
            // Clear bottom input area and hide it for buttons
            inputArea.innerHTML = '';
            
            if (step.type === 'choice') {
                // Add buttons directly in the message flow
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'message agent-message';
                const choicesHtml = step.choices.map(choice => 
                    `<button class="choice-btn" data-value="${choice.value}">${choice.label}</button>`
                ).join('');
                choicesDiv.innerHTML = `
                    <div style="width: 40px;"></div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                        ${choicesHtml}
                    </div>
                `;
                messagesDiv.appendChild(choicesDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                inputArea.classList.add('hidden');
                
                choicesDiv.querySelectorAll('.choice-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const value = btn.dataset.value;
                        formData[step.field] = value;
                        choicesDiv.remove(); // Remove the choices after selection
                        addMessage('user', btn.textContent);
                        
                        // Handle edit option - refresh page to start over
                        if (step.handleEdit && value === 'edit') {
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                            return;
                        }
                        
                        currentStep++;
                        setTimeout(() => nextStep(), 500);
                    });
                });
            } else if (step.type === 'multichoice') {
                // Add buttons directly in the message flow
                const choicesDiv = document.createElement('div');
                choicesDiv.className = 'message agent-message';
                const choicesHtml = step.choices.map(choice => 
                    `<button class="choice-btn" data-value="${choice.value}">${choice.label}</button>`
                ).join('');
                const continueBtn = step.optional 
                    ? '<button id="skipBtn" class="choice-btn" style="background: #f3f4f6; margin-top: 0.5rem;">×“×œ×’</button>'
                    : '';
                choicesDiv.innerHTML = `
                    <div style="width: 40px;"></div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.5rem;">
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${choicesHtml}
                        </div>
                        ${step.allowCustom ? `
                            <div class="text-input-box" style="margin-top: 0.5rem;">
                                <input type="text" id="customInput" placeholder="${step.customPlaceholder}" style="flex: 1; padding: 0.5rem 0.75rem; border: 1.5px solid #e5e7eb; border-radius: 1.5rem; font-size: 0.875rem;">
                                <button id="addCustom" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 1.5rem; cursor: pointer; font-size: 0.875rem;">×”×•×¡×£</button>
                            </div>
                        ` : ''}
                        <button id="continueBtn" class="choice-btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; align-self: flex-start; margin-top: 0.5rem;">×”××©×š</button>
                        ${continueBtn}
                    </div>
                `;
                messagesDiv.appendChild(choicesDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                inputArea.classList.add('hidden');
                
                if (!formData[step.field]) formData[step.field] = [];
                
                choicesDiv.querySelectorAll('.choice-btn[data-value]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        btn.classList.toggle('selected');
                        const value = btn.dataset.value;
                        if (btn.classList.contains('selected')) {
                            formData[step.field].push(value);
                        } else {
                            formData[step.field] = formData[step.field].filter(v => v !== value);
                        }
                    });
                });
                
                if (step.allowCustom) {
                    choicesDiv.querySelector('#addCustom').addEventListener('click', () => {
                        const input = choicesDiv.querySelector('#customInput');
                        if (input.value.trim()) {
                            formData[step.field].push(input.value.trim());
                            input.value = '';
                        }
                    });
                }
                
                choicesDiv.querySelector('#continueBtn').addEventListener('click', () => {
                    if (formData[step.field].length > 0 || step.optional) {
                        const response = formData[step.field].length > 0 
                            ? formData[step.field].join(", ")
                            : "××™×Ÿ ×”×¢×“×¤×•×ª ××™×•×—×“×•×ª";
                        choicesDiv.remove(); // Remove choices after selection
                        addMessage('user', response);
                        currentStep++;
                        setTimeout(() => nextStep(), 500);
                    } else {
                        alert('×‘×—×¨ ×œ×¤×—×•×ª ××•×¤×¦×™×” ××—×ª');
                    }
                });
                
                if (step.optional) {
                    choicesDiv.querySelector('#skipBtn').addEventListener('click', () => {
                        choicesDiv.remove();
                        addMessage('user', "×“×œ×’");
                        currentStep++;
                        setTimeout(() => nextStep(), 500);
                    });
                }
            } else if (step.type === 'budget') {
                inputArea.classList.remove('hidden');
                inputArea.innerHTML = `
                    <div style="max-width: 500px; margin: 0 auto;">
                        <div class="mb-3">
                            <input type="number" id="minPrice" placeholder="××™× ×™××•× (××•×¤×¦×™×•× ×œ×™)" 
                                   class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-2xl text-sm focus:outline-none focus:border-blue-500">
                        </div>
                        <div class="mb-3">
                            <input type="number" id="maxPrice" placeholder="××§×¡×™××•× (××•×¤×¦×™×•× ×œ×™)" 
                                   class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-2xl text-sm focus:outline-none focus:border-blue-500">
                        </div>
                        <button id="budgetContinue" class="w-full px-4 py-2.5 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl font-medium text-sm">×”××©×š</button>
                    </div>
                `;
                
                document.getElementById('budgetContinue').addEventListener('click', () => {
                    const min = document.getElementById('minPrice').value;
                    const max = document.getElementById('maxPrice').value;
                    formData.minPrice = min || null;
                    formData.maxPrice = max || null;
                    
                    const response = [];
                    if (min) response.push(`××™× ×™××•× ${parseInt(min).toLocaleString()} ×©"×—`);
                    if (max) response.push(`××§×¡×™××•× ${parseInt(max).toLocaleString()} ×©"×—`);
                    
                    addMessage('user', response.length > 0 ? response.join(", ") : "×’××™×© ×‘×ª×§×¦×™×‘");
                    inputArea.classList.add('hidden');
                    currentStep++;
                    setTimeout(() => nextStep(), 500);
                });
            } else if (step.type === 'text') {
                inputArea.classList.remove('hidden');
                inputArea.innerHTML = `
                    <div class="text-input-box">
                        <input type="${step.inputType || 'text'}" id="textInput" placeholder="${step.placeholder}" style="flex: 1; padding: 0.625rem 1rem; border: 2px solid #e5e7eb; border-radius: 1.5rem; font-size: 0.875rem;">
                        <button id="sendText" style="padding: 0.625rem 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 1.5rem; cursor: pointer; font-weight: 500; font-size: 0.875rem;">×©×œ×—</button>
                    </div>
                    ${step.optional ? '<button id="skipTextBtn" class="choice-btn mt-2" style="background: #f3f4f6;">×“×œ×’</button>' : ''}
                `;
                
                const sendBtn = document.getElementById('sendText');
                const input = document.getElementById('textInput');
                
                const handleSend = () => {
                    const value = input.value.trim();
                    if (value || step.optional) {
                        formData[step.field] = value || null;
                        addMessage('user', value || "×“×œ×’");
                        inputArea.classList.add('hidden');
                        currentStep++;
                        setTimeout(() => nextStep(), 500);
                    }
                };
                
                sendBtn.addEventListener('click', handleSend);
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleSend();
                });
                
                if (step.optional) {
                    document.getElementById('skipTextBtn').addEventListener('click', () => {
                        formData[step.field] = null;
                        addMessage('user', "×“×œ×’");
                        inputArea.classList.add('hidden');
                        currentStep++;
                        setTimeout(() => nextStep(), 500);
                    });
                }
                
                input.focus();
            } else if (step.type === 'complete') {
                inputArea.classList.add('hidden');
                setTimeout(() => submitData(), 2000);
            }
        }
        
        function nextStep() {
            if (currentStep >= conversation.length) return;
            
            const step = conversation[currentStep];
            
            let message = step.agent;
            if (typeof message === 'function') {
                message = message(formData);
            }
            
            // Skip this step if message is null and skipIfNull is true
            if (message === null && step.skipIfNull) {
                currentStep++;
                nextStep();
                return;
            }
            
            const typingElement = showTyping();
            
            setTimeout(() => {
                removeTyping(typingElement);
                
                addMessage('agent', message);
                
                if (step.type) {
                    setTimeout(() => showInput(step), 800);
                } else {
                    currentStep++;
                    setTimeout(() => nextStep(), step.delay || 1000);
                }
            }, step.delay || 1000);
        }
        
        async function submitData() {
            try {
                const response = await fetch('/api/save-onboarding', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    window.location.href = result.redirect;
                } else {
                    alert('×©×’×™××”: ' + result.error);
                }
            } catch (error) {
                alert('×©×’×™××” ×‘×©××™×¨×”. × ×¡×” ×©×•×‘.');
            }
        }
        
        // Start conversation
        nextStep();
    </script>
</body>
</html>
